<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head lang="en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,700">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
</head>
<body>
<style>
    .ajax-loader {
        visibility: visible;
        background-color: rgba(255,255,255,0.7);
        position: absolute;
        z-index: +100 !important;
        width: 100%;
        height:100%;
    }
    .ajax-loader img {
        position: relative;
        top:50%;
        left:50%;
    }
    .shine {
        background: #f6f7f8;
        background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
        background-repeat: no-repeat;
        width: auto;
        display: inline-block;
        position: relative;
        -webkit-animation-duration: 1s;
        -webkit-animation-fill-mode: forwards;
        -webkit-animation-iteration-count: infinite;
        -webkit-animation-name: placeholderShimmer;
        -webkit-animation-timing-function: linear;
    }
    box {
        height: 104px;
        width: 100px;
    }
    lines {
        height: 10px;
        margin-top: 10px;
        width: 200px;
    }
    photo {
        display: block!important;
        width: 325px;
        height: 100px;
        margin-top: 15px;
    }
    @-webkit-keyframes placeholderShimmer {
        0% {
            background-position: -468px 0;
        }
        100% {
            background-position: 468px 0;
        }
    }
    nav{
        background-color: #ffffff ;padding-top:10px;padding-bottom: 10px;box-shadow: 0 4px 8px 0 rgba(0,0,0,0.08);border-radius: 10px;
    }

</style>
<header th:insert="header.html ::  nav"></header>
<div class="container-fluid mt-5">
    <div class="col-md-12">
        <div class="row">
            <div class="col-md-2">
                <div style="position: fixed; " th:insert="home/sidenav.html ::  sidenav"></div>
            </div>
            <div class="col-md-10 ml-5" style="left: 12% ;" >
                <div th:if="${param.error}">
                    <div class="alert alert-info" th:text="${message}}">Room is not available.</div>
                </div>

                <nav class="navbar navbar-light " >
                    <a class="navbar-brand mb-0 h1" href="#">Public Rooms</a>
                    <ul class="nav  justify-content-center " >
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-12 ">
                                    <div class="row">
                                        <li class="nav-item " >
                                            <a class="nav-link active" href="#" style="color: #3b5998;font-weight: 500"  ><i class="fas fa-id-badge"></i> Profiles <span class="badge badge-primary ml-1">3</span> </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" style="color:orangered;font-weight: 500"><i class="fas fa-broadcast-tower"></i> Rooms <span class="badge badge-danger ml-1" id="broadcast"></span> </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" style="color:green;font-weight: 500"><i class="fas fa-user-friends"></i> Online Users <span class="badge badge-success ml-1" th:text="${activeuser}">
                                       </span></a>
                                        </li>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </ul>
                    <form class="form-inline  my-2 my-lg-0  mr-3" >
                        <div class="row">
                            <div class="form-group mr-3" >
                                <input type="text" class="form-control " id="search_box" name="search_box" placeholder="Room Name">
                            </div>
                            <button type="button" class="btn btn-default" data-toggle="modal" data-target="#createRoom">
                               Create Room <i class="fa fa-user-friends"></i>
                            </button>

                            <!-- Modal -->
                            <div class="modal fade" id="createRoom" tabindex="-1" role="dialog" aria-labelledby="createRoom" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLongTitle">Rooms</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form action="/api/chatroom/create" th:action="@{/api/chatroom/create}" th:object="${chatRoom}" id="form-room" method="post" >
                                                    <div class="form-group">
                                                        <label for="roomName">Room Name</label><br>
                                                        <input type="text" class="form-control" name="roomName" id="roomName" >
                                                    </div>
                                                    <br>
                                                    <div class="form-group">
                                                        <label for="roomDescription">Room Description</label><br>
                                                        <textarea class="form-control" name="roomDescription" id="roomDescription" ></textarea>
                                                    </div><br>
                                                    <div class="form-group">
                                                        <label for="roomType">Room Type</label><br>
                                                        <select  class="form-control" name="roomType" id="roomType" >
                                                            <option th:value="PRIVATE">Private</option>
                                                            <option th:value="PUBLIC">Public</option>
                                                        </select>
                                                    </div><br>
                                                    <button class="btn btn-primary btn-block" id="btn"  type="submit">Save</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>
                    <!-- Button trigger modal -->

                </nav>
                <div class="container" th:if="${error} != null">
                    <div class="alert alert-danger" id="alert">
                        <b th:text="${error}"></b>
                    </div>
                </div>
                <div class="chatrooms mt-5"  id="chatrooms" >
                </div>
                <div class="ajax-loader">
                    <photo class="shine" id="shimmer-photo"></photo>
                    <photo class="shine" id="shimmer-photo"></photo>
                    <photo class="shine" id="shimmer-photo"></photo>
                    <photo class="shine" id="shimmer-photo"></photo>
                    <photo class="shine" id="shimmer-photo"></photo>
                </div>
                <div  class="results">
                </div>
                <div  class="rooms" >
                </div>
            </div>
        </div>
    </div>
</div>
</div>
</body>
<script src="https://kit.fontawesome.com/6f40d29aa1.js" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script>
    $(document).ready(function() {

        var poll = function () {
            jQuery.ajax({
                url: '/chatRooms',
                dataType: 'json',
                type: 'get',
                async: false,
                beforeSend:function(){
                    $('.ajax-loader').css("visibility", "visible");
                    $('#shimmer-photo').show();
                },
                success: function (data) {
                    $('#shimmer-photo').hide();
                    $('.ajax-loader').css("visibility", "hidden");
                    var obj = JSON.parse(JSON.stringify(data));
                    var responses = "";
                    for (var i =0 ; i <= obj.length ; i++){
                        var  result = `
                                           <div class="card bg-light mb-3 mr-5  ml-5 mt-2 " id="custom-card-design">
                                               <div class="card-body">
                                                  <h5 class="card-title">`+obj[i].chatRoomName +`</h5>
                                                   <p class="card-text">`+obj[i].chatRoomDescription+`</p><br>
                                                   <form action="/chatroom/`+obj[i].id +`">
                                                      <button class='btn btn-success' type='submit'>Join Room</button>
                                                    </form>
                                               </div>
                                            </div>
                              `;
                        responses += result;
                        $('.results').html(responses);
                        $('#broadcast').text(data.length);
                    }
                },

                error:function (error) {
                    console.log("error");
                },
                complete:function (data) {
                    $('.ajax-loader').css("visibility", "hidden");
                }
            });
        };
        setInterval(function () {
            poll();
        },10000)


        // used for the searching the chatroom
        $('#search_box').keyup(function(){

            var search_term = $('#search_box').val();

            $.ajax({
                url: '/api/chatroom/search/'+search_term,
                dataType: 'text',
                type: 'get',
                async: false,
                success: function(response){
                    if(search_term.length > 0){
                        for (var i = 1 ;i<=search_term.length;i++){
                            $('.results').html(response);
                        }
                    }
                },error:function (error) {
                    poll();
                },

            });

        });




        var createRoom = $('#form-room');

        createRoom.submit(function (e) {
            e.preventDefault();
            $.ajax({
                url:createRoom.attr('action'),
                type:createRoom.attr('method'),
                data:form.serialize(),
                beforeSend:function(data){
                    // $('.btn').html('<div class="spinner-border m-5" role="status">\n' +
                    //     '  <span class="sr-only">Loading...</span>\n' +
                    //     '</div>');
                    // console.log('sending some messages');
                }, success:function (data) {
                    console.log(data)
                },error:function (error) {
                    $('#alert').html(`   <div class="alert alert-danger" role="alert">  Error </div> `);
                    console.log('error while submitting the form');
                }
            })
        })


    });

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</html>